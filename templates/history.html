<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>History</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
  <style>
    /* Một vài style cơ bản để bảng nhìn ổn */
    body{font-family:Inter,Arial,Helvetica,sans-serif;background:#f4f6fb;color:#0f172a;margin:0;padding:20px}
    .container{max-width:1100px;margin:0 auto}
    h1{margin:0 0 10px}
    .nav{margin:8px 0 18px}
    .filter{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    .filter input{padding:6px 8px;border-radius:6px;border:1px solid rgba(0,0,0,0.08)}
    .filter button{padding:8px 12px;border-radius:8px;border:0;background:#1f6feb;color:#fff;cursor:pointer}
    table.hist{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
    table.hist th, table.hist td{padding:10px 12px;border-bottom:1px solid rgba(0,0,0,0.04);font-size:14px}
    table.hist thead th{background:#f8fafc;text-align:left}
    .proof-thumb{width:88px;height:66px;object-fit:cover;border-radius:6px;border:1px solid rgba(0,0,0,0.06)}
    .empty{padding:18px;text-align:center;color:#666}
  </style>
</head>
<body>
  <div id="app" class="container">
    <h1>Lịch sử điểm danh</h1>
    <div class="nav">
      <a href="{{ url_for('index') }}">Trở lại</a> |
      <a href="{{ url_for('export') }}">Xuất Excel</a>
    </div>
    
<form @submit.prevent="filter" class="filter">
  <label>
    Ngày (từ): <input type="date" v-model="filters.dateFrom">
  </label>
  <label>
    Ngày (đến): <input type="date" v-model="filters.dateTo">
  </label>
  <label>
    Mã nhân viên: <input v-model="filters.empId" placeholder="tùy chọn">
  </label>
  <!-- <button type="submit">Lọc</button> -->

  <!-- Export controls -->
  <div style="margin-left:12px; display:flex; gap:8px; align-items:center;">
    <label>
      Chọn tháng xuất dữ liệu: <input type="month" v-model="monthPick">
    </label>
    <button type="button" @click="exportMonth" class="filter-export">Xuất tháng</button>
    <button type="button" @click="exportRange" class="filter-export">Xuất theo khoảng</button>
  </div>
</form>
    
    <table class="hist">
      <thead>
        <tr>
          <th>#</th>
          <th>Thời gian</th>
          <th>Ngày</th>
          <th>Nhân viên</th>
          <th>Loại</th>
          <th>Chứng cứ</th>
          <th>Độ tin cậy</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(rec, idx) in filteredHistory" :key="idx">
          <td>${idx + 1}</td>
          <td>${formatTime(rec.timestamp)}</td>
          <td>${formatDate(rec.timestamp)}</td>
          <td>${rec.name} (${rec.employee_id})</td>
          <td>${rec.type || '-'}</td>
          <td>
            <a v-if="rec.proof" :href="getProofUrl(rec.proof)" target="_blank" rel="noopener">
              <img :src="getProofUrl(rec.proof)" class="proof-thumb" alt="proof">
            </a>
            <span v-else>-</span>
          </td>
          <td>${rec.confidence != null ? Number(rec.confidence).toFixed(3) : '-'}</td>
        </tr>
        <tr v-if="!filteredHistory.length">
          <td colspan="7" class="empty">No records</td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <!-- ---------- Tách dữ liệu history ra thẻ JSON để tránh lỗi editor/linters ---------- -->
  <script id="history-data" type="application/json">
    {{ history|tojson|safe }}
  </script>
  <script id="filters-data" type="application/json">
    {
      "date": {{ date_filter|tojson|default("null") }},
      "empId": {{ emp_filter|tojson|default("null") }}
    }
  </script>
  <script>
    new Vue({
      el: '#app',
      delimiters: ['${', '}'],
      data: (function(){
        // safe parse for history + filters: if templates not rendered (contains '{{') fallback
        const out = { history: [], filters: { dateFrom: null, dateTo: null, empId: null }, monthPick: '' };
        // history
        try {
          const htxt = document.getElementById('history-data') ? document.getElementById('history-data').textContent.trim() : '';
          if (!htxt || htxt.indexOf('{{') !== -1) out.history = [];
          else out.history = JSON.parse(htxt);
        } catch (e) { out.history = []; }
        // filters-data
        try {
          const ftxt = document.getElementById('filters-data') ? document.getElementById('filters-data').textContent.trim() : '';
          if (!ftxt || ftxt.indexOf('{{') !== -1) {
            out.filters = { dateFrom: null, dateTo: null, empId: null };
          } else {
            const f = JSON.parse(ftxt);
            out.filters = { dateFrom: f.date || null, dateTo: f.date || null, empId: f.empId || (f.emp_id || '') };
          }
        } catch (e) { out.filters = { dateFrom: null, dateTo: null, empId: null }; }
        return out;
      })(),
 
     },
         computed: {
      // filteredHistory được dùng để render bảng
      filteredHistory() {
        // Return reversed chronological order by timestamp (latest first)
        const list = Array.isArray(this.history) ? this.history.slice() : [];
        // Normalize timestamps -> each rec should have a date string "YYYY-MM-DD"
        const normalizeDate = (rec) => {
          if (rec.date) return rec.date;
          if (rec.timestamp) return String(rec.timestamp).split('T')[0];
          return null;
        };

        // parse filters
        const from = this.filters.dateFrom ? this.parseDateSafe(this.filters.dateFrom) : null;
        const to = this.filters.dateTo ? this.parseDateSafe(this.filters.dateTo) : null;
        const empFilter = (this.filters.empId || '').toString().trim();

        return list.filter(rec => {
          const rd = normalizeDate(rec);
          if (!rd) return false; // ignore records without date
          const rdDate = this.parseDateSafe(rd);
          if (!rdDate) return false;

          // date range filter (inclusive)
          if (from && rdDate < from) return false;
          if (to && rdDate > to) return false;

          // emp id filter (if provided) - match exactly
          if (empFilter) {
            if (String(rec.employee_id) !== empFilter && String(rec.employee_id).indexOf(empFilter) === -1) return false;
          }
          return true;
        }).sort((a,b) => {
          // sort desc by timestamp if available, else by date/time fields
          const ta = a.timestamp || (a.date ? (a.date + 'T' + (a.time || '00:00:00')) : '');
          const tb = b.timestamp || (b.date ? (b.date + 'T' + (b.time || '00:00:00')) : '');
          // compare strings ISO-like => works for lexicographic compare
          if (ta < tb) return 1;
          if (ta > tb) return -1;
          return 0;
        });
      }
    },
      methods: {
        parseDateSafe(s) {
        if (!s) return null;
        // accept YYYY-MM-DD or ISO timestamp
        try {
          // If already Date
          if (s instanceof Date) return s;
          // If format YYYY-MM-DD
          const parts = String(s).split('T')[0].split('-');
          if (parts.length === 3) {
            const y = Number(parts[0]), m = Number(parts[1]) - 1, d = Number(parts[2]);
            return new Date(y, m, d);
          }
          // fallback Date parse
          const d = new Date(s);
          if (isNaN(d.getTime())) return null;
          return new Date(d.getFullYear(), d.getMonth(), d.getDate());
        } catch (e) {
          return null;
        }
      },
         formatTime(ts) {
        if (!ts) return '';
        const parts = String(ts).split('T');
        return parts[1] || '';
      },
      formatDate(ts) {
        if (!ts) return '';
        const parts = String(ts).split('T');
        return parts[0] || '';
      },

      getProofUrl(filename) {
        // Prefer runtime API_BASE if available (frontend static + backend on Render).
        if (window && window.API_BASE) return window.API_BASE.replace(/\/$/, '') + '/thumbs/' + encodeURIComponent(filename);
        // If template was server-rendered, try Flask url_for output (it may be empty text with '{{' if not rendered).
        const rendered = `{{ url_for('proofs', filename='') }}`;
        if (rendered && rendered.indexOf('{{') === -1) return rendered + filename;
        // fallback relative path
        return '/thumbs/' + encodeURIComponent(filename);
      },

      // filter button (keeps client-side behaviour, but you can use it to trigger)
      filter() {
        // nothing needed: computed property updates automatically
        // but keep for compatibility with form submit
        console.log("asdasd");
        
        return;
      },

      // Export month -> opens server export route ?month=YYYY-MM
      exportMonth() {
        if (!this.monthPick) { alert('Chọn tháng trước khi xuất.'); return; }
        const emp = this.filters.empId ? `&empId=${encodeURIComponent(this.filters.empId)}` : '';
        window.location.href = `/export?month=${encodeURIComponent(this.monthPick)}${emp}`;
      },

      // Export range -> opens server export route from_date & to_date
      exportRange() {
        if (!this.filters.dateFrom && !this.filters.dateTo) {
          alert('Chọn ngày bắt đầu và/hoặc ngày kết thúc để xuất.');
          return;
        }
        const from = this.filters.dateFrom ? `from_date=${encodeURIComponent(this.filters.dateFrom)}` : '';
        const to = this.filters.dateTo ? `&to_date=${encodeURIComponent(this.filters.dateTo)}` : '';
        const emp = this.filters.empId ? `&empId=${encodeURIComponent(this.filters.empId)}` : '';
        const q = [from, to, emp].filter(Boolean).join('&');
        window.location.href = `/export?${q}`;
  },
      }
    });
  </script>
</body>
</html>
