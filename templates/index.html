<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Employees</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
  <style>
    :root{
      --bg:#f4f6fb; --card:#ffffff; --muted:#6b7280; --accent:#1f6feb; --accent-2:#0ea5a4;
      --shadow: 0 6px 18px rgba(15,23,42,0.06);
      --radius:12px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    
    html,body{height:100%;margin:0;background:var(--bg);color:#0f172a}
    .container{max-width:1100px;margin:28px auto;padding:20px}
    
    /* Top app bar */
    .appbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
    h1{margin:0;font-size:20px}
    .subtitle{color:var(--muted);font-size:13px}
    
    /* Taskbar (tabs) */
    .taskbar{display:flex;gap:8px;background:transparent;padding:8px;border-radius:10px}
    .tab{background:transparent;border:0;padding:8px 14px;border-radius:10px;font-weight:600;color:var(--muted);cursor:pointer;transition:all .18s ease;display:flex;align-items:center;gap:8px}
    .tab:hover{background:rgba(15,23,42,0.04);color:#0f172a}
    .tab.active{background:linear-gradient(90deg,rgba(31,111,235,0.12),rgba(14,165,164,0.06));box-shadow:var(--shadow);color:var(--accent);}
    
    /* toolbar on right */
    .right-tools{display:flex;align-items:center;gap:10px}
    .search{border:1px solid rgba(15,23,42,0.06);background:white;padding:8px 10px;border-radius:10px;min-width:220px;display:flex;align-items:center;gap:8px}
    .search input{border:0;outline:none;font-size:14px}
    .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:9px;border:0;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(31,111,235,0.12)}
    
    /* main area */
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-top:18px}
    @media(max-width:980px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:720px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:420px){.grid{grid-template-columns:1fr}}
    
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:var(--shadow);display:flex;gap:12px;align-items:center}
    .avatar{width:72px;height:72px;border-radius:10px;flex-shrink:0;overflow:hidden;border:1px solid rgba(15,23,42,0.04);display:flex;align-items:center;justify-content:center}
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{flex:1}
    .meta .name{font-weight:700;color:#0f172a}
    .meta .id{color:var(--muted);font-size:13px;margin-top:6px}
    .meta .actions{margin-top:8px;display:flex;gap:8px}
    .pill{font-size:12px;padding:6px 8px;border-radius:8px;background:rgba(15,23,42,0.04);color:var(--muted);}
    
    .empty{padding:28px;background:linear-gradient(180deg,rgba(255,255,255,0.6),transparent);border-radius:12px;text-align:center;color:var(--muted)}
    
    /* small helpers */
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div id="app" class="container">
    <div class="appbar">
      <div class="brand">
        <div class="logo">HR</div>
        <div>
          <h1>Nhân viên</h1>
          <div class="subtitle">Quản lý nhân viên</div>
        </div>
      </div>
      
      <div class="right-tools">
        <div class="taskbar" role="tablist">
          <button class="tab" :class="{active:activeTab==='register'}" @click="go('register')">Đăng ký</button>
          <button class="tab" :class="{active:activeTab==='live'}" @click="go('live')">Nhận diện trực tiếp</button>
          <button class="tab" :class="{active:activeTab==='history'}" @click="go('history')">Lịch sử</button>
          <button class="tab" :class="{active:activeTab==='export'}" @click="go('export')">Xuất Excel</button>
        </div>
        
        <div class="search" title="Search employees">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <input placeholder="Tìm kiếm theo tên hoặc ID" v-model="filterText" @input="applyFilter">
        </div>
        
        <button class="btn" @click="refresh">Làm mới</button>
        <!-- Health check button -->
        <button class="btn ghost" @click="checkHealth" style="margin-left:8px;background:#fff;color:#111;border:1px solid rgba(0,0,0,0.06)">Check backend</button>
      </div>
    </div>
    
    <div v-if="filtered.length" class="grid">
      <div class="card" v-for="emp in filtered" :key="emp.id">
        <div class="avatar">
          <img :src="getThumbUrl(emp.id)" @error="useDefaultImg" :alt="emp.name">
        </div>
        <div class="meta">
          <div class="name">${emp.name}</div>
          <div class="id">ID: ${emp.id}</div>
          
          <div class="actions" style="margin-top:8px">
            <a :href="`/employee/${emp.id}/edit`" class="pill">Chỉnh sửa</a>
            
            <!-- Option A: API delete via JS -->
            <button @click="confirmDelete(emp.id)" class="pill" style="background:#fff4f6;border:1px solid rgba(160,0,0,0.06);color:#a00;cursor:pointer">Xóa</button>
          </div>
        </div>
      </div>
    </div>
    
    <div v-else class="empty">
      No employees yet. <a :href="urlFor('register')">Đăng ký mới</a>.
    </div>
  </div>
  
  <script id="initial-data" type="application/json">
    {{ employees|tojson|safe }}
  </script>
  <script>
    new Vue({
      el: '#app',
      delimiters: ['${','}'],
      data: {
        employees: JSON.parse(document.getElementById('initial-data').textContent || '[]'),
        filterText: '',
        filtered: [],
        activeTab: 'employees'
      },
      created(){
        this.filtered = this.employees.slice();
        // pick active tab from current path (simple heuristic)
        const path = window.location.pathname || '';
        if(path.includes('live')) this.activeTab = 'live';
        else if(path.includes('register')) this.activeTab = 'register';
        else if(path.includes('history')) this.activeTab = 'history';
        else if(path.includes('export')) this.activeTab = 'export';
        else this.activeTab = 'employees';
      },
      methods: {
        async confirmDelete(id) {
          if (!confirm(`Delete employee ${id}? This cannot be undone.`)) return;
          try {
            // dùng POST fallback nếu bạn không muốn API DELETE
            const resp = await fetch(`/api/employee/${encodeURIComponent(id)}`, { method: 'DELETE' });
            if (!resp.ok) {
              const txt = await resp.text();
              throw new Error(txt || ('Server ' + resp.status));
            }
            window.location.reload();
          } catch (err) {
            alert('Delete failed: ' + (err.message || err));
          }
        },
        getThumbUrl(id){
          // Prefer runtime API_BASE if present (e.g. frontend hosted on GitHub Pages, backend on Render)
          if (window && window.API_BASE) return window.API_BASE.replace(/\/$/, '') + '/thumbs/' + encodeURIComponent(id) + '.jpg';
          // If server rendered, the relative path will work.
          return `/thumbs/${encodeURIComponent(id)}.jpg`;
        },
        useDefaultImg(e){ e.target.src = 'https://via.placeholder.com/120x120?text=No+Img'; },

        applyFilter(){
          const q = this.filterText.trim().toLowerCase();
          if(!q){ this.filtered = this.employees.slice(); return }
          this.filtered = this.employees.filter(e => (e.name||'').toLowerCase().includes(q) || String(e.id).includes(q));
        },
        refresh(){ window.location.reload(); },
        go(route){
          // Prefer backend-hosted pages if API_BASE provided; otherwise use server-rendered URL map.
          const renderedMap = { register: '{{ url_for("register") }}', live: '{{ url_for("live_page") }}', history: '{{ url_for("history") }}', export: '{{ url_for("export") }}' };
          if (window && window.API_BASE) {
            // navigate to backend UI paths
            const paths = { register: '/register', live: '/live', history: '/history', export: '/export' };
            const p = paths[route] || '/';
            window.location.href = window.API_BASE.replace(/\/$/, '') + p;
            return;
          }
          const target = renderedMap[route] && renderedMap[route].indexOf('{{') === -1 ? renderedMap[route] : '/';
          window.location.href = target;
        },
        urlFor(name){ const map = { register: '{{ url_for("register") }}', live: '{{ url_for("live_page") }}', history: '{{ url_for("history") }}', export: '{{ url_for("export") }}' }; return map[name] || '#'; },
        async checkHealth(){
        console.log("123123");
        
          const base = window.API_BASE ? window.API_BASE.replace(/\/$/,'') : '';
          const urlCandidates = [];
          if (base) urlCandidates.push(base + '/health', base + '/api/health');
          // also try relative paths if app served by Flask
          urlCandidates.push('/health', '/api/health');
          for (const u of urlCandidates) {
            try {
              const r = await fetch(u, { cache: 'no-store' });
              if (r.ok) { alert('Backend reachable: ' + u); return; }
            } catch (e){}
          }
          alert('Backend not reachable. Check Render service URL and CORS.');
        }
      }
    })
  </script>
  <!-- Insert the small API_BASE configuration widget so users of the static site can set backend URL at runtime -->
  <script>
  (function(){
    try {
      const key = 'frs_api_base';
      // restore saved value if exists
      const saved = localStorage.getItem(key);
      if (!window.API_BASE && saved) {
        window.API_BASE = saved;
        console.log('FRS: restored API_BASE from localStorage', window.API_BASE);
      }

      // create UI only if page is interactive
      const ui = document.createElement('div');
      ui.id = 'frs-api-widget';
      ui.style = 'position:fixed;right:14px;top:14px;z-index:99999;background:rgba(255,255,255,0.98);border:1px solid rgba(0,0,0,0.06);padding:10px;border-radius:8px;box-shadow:0 6px 18px rgba(15,23,42,0.06);font-family:Arial,Helvetica,sans-serif;font-size:13px;';
      ui.innerHTML = ''
        + '<div style="margin-bottom:6px;font-weight:600;color:#0f172a">FRS backend</div>'
        + '<input id="frs-api-input" placeholder="https://your-backend.example.com" style="width:260px;padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.08);margin-bottom:6px;display:block">'
        + '<div style="display:flex;gap:6px;align-items:center"><button id="frs-api-save" style="padding:6px 8px;border-radius:6px;border:0;background:#1f6feb;color:#fff;cursor:pointer">Save</button>'
        + '<button id="frs-api-clear" style="padding:6px 8px;border-radius:6px;border:1px solid rgba(0,0,0,0.06);background:#fff;cursor:pointer">Clear</button>'
        + '<button id="frs-api-test" style="padding:6px 8px;border-radius:6px;border:1px solid rgba(0,0,0,0.06);background:#fff;cursor:pointer">Test</button>'
        + '<button id="frs-api-close" style="margin-left:6px;padding:6px 8px;border-radius:6px;border:0;background:transparent;cursor:pointer;color:#666">✕</button></div>'
        + '<div id="frs-api-msg" style="margin-top:8px;color:#666;font-size:12px"></div>';

      document.body.appendChild(ui);

      const input = document.getElementById('frs-api-input');
      const save = document.getElementById('frs-api-save');
      const clear = document.getElementById('frs-api-clear');
      const test = document.getElementById('frs-api-test');
      const closeBtn = document.getElementById('frs-api-close');
      const msg = document.getElementById('frs-api-msg');

      if (saved) input.value = saved;

      function setMsg(s, ok){
        msg.textContent = s;
        msg.style.color = ok ? '#0a7' : '#c33';
      }

      save.addEventListener('click', () => {
        const v = (input.value || '').trim().replace(/\/+$/,'');
        if (!v) { setMsg('Empty URL not saved', false); return; }
        localStorage.setItem(key, v);
        window.API_BASE = v;
        setMsg('Saved API_BASE: ' + v, true);
        console.log('FRS: API_BASE set to', v);
      });

      clear.addEventListener('click', () => {
        localStorage.removeItem(key);
        delete window.API_BASE;
        input.value = '';
        setMsg('Cleared', true);
        console.log('FRS: API_BASE cleared');
      });

      test.addEventListener('click', async () => {
        const base = window.API_BASE || (input.value||'').trim().replace(/\/+$/,'');
        if (!base) { setMsg('Set API_BASE first', false); return; }
        setMsg('Testing...', true);
        try {
          const urls = [base + '/health', base + '/api/health', base + '/'];
          let ok = false;
          for (const u of urls) {
            try {
              const r = await fetch(u, { method: 'GET', cache: 'no-store' });
              if (r.ok) { setMsg('Backend reachable: ' + u, true); ok = true; break; }
            } catch(e){}
          }
          if (!ok) setMsg('No reachable endpoint found at ' + base, false);
        } catch (e) {
          setMsg('Test error: ' + (e.message||e), false);
        }
      });

      closeBtn.addEventListener('click', () => {
        ui.style.display = 'none';
      });

      // small keyboard helper: press Ctrl+Shift+A to toggle widget visibility
      window.addEventListener('keydown', (ev) => {
        if (ev.ctrlKey && ev.shiftKey && ev.key.toLowerCase() === 'a') {
          ui.style.display = (ui.style.display === 'none') ? 'block' : 'none';
        }
      });
    } catch (e) { console.warn('FRS widget init error', e); }
  })();
  </script>
</body>
</html>
